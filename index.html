<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Coin Flip App</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
   <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- HEADER -->
    <header class="header">
       <div class="user-info">
          <p class="username" id="username">User</p>
          <p class="welcome-text">Welcome Back 
             <img 
                src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/main/Travel%20and%20Places/Rocket.webp" 
                alt="Rocket Emoji" 
                width="30"  <!-- Increased size -->
          </p>
       </div>
       <img src="profile.png" alt="Profile Picture" id="profile-pic" class="profile-pic">
    </header>

<!-- Balance & Withdraw Container -->
<div class="balance-container">
   <!-- Wrapper to ensure icon and balance text stay together -->
   <div class="balance-wrapper">
       <!-- ALGO Icon -->
       <img src="algo-icon.png" alt="Algo Icon" class="algo-icon">
       
       <!-- Balance Text -->
       <div class="balance-text">
          <p class="balance-label">Balance</p>
          <p class="user-balance" id="user-balance">Loading...</p> <!-- Initially show loading -->
       </div>
   </div>

   <!-- The Withdraw Button is now used for refreshing the balance -->
   <button class="withdraw-button" onclick="refreshBalance()">Refresh</button> <!-- Refresh functionality on Withdraw Button -->
</div>

    <!-- Coin Flip Animation -->
    <div id="coin-flip-container">
       <div id="coin-animation"></div>
    </div>

    <!-- Bet Amount Section -->
    <div class="bet-amount-container">
        <input type="text" id="bet-amount" list="BetSize" placeholder="Enter or Select Amount">
        <datalist id="BetSize">
            <option value="10"></option>
            <option value="20"></option>
            <option value="50"></option>
            <option value="100"></option>
        </datalist>
    </div>

    <!-- Heads & Tails Selection -->
    <div class="button-container">
       <button class="coin-button" id="heads">
          <div class="top">HEADS</div>
          <div class="bottom"></div>
       </button>
       <button class="coin-button" id="tails">
          <div class="top">TAILS</div>
          <div class="bottom"></div>
       </button>
    </div>

    <!-- Spin Button -->
    <div class="spin-container">
       <button class="spin-button">
          <div class="top">
             SPIN 
             <img 
                src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/main/Objects/Money%20Bag.webp"  
                alt="Money Bag Emoji" 
                width="30"  <!-- Increased size -->
          </div>
          <div class="bottom"></div>
       </button>
    </div>

    <!-- Add this below your spin button or wherever you'd like to show the error message -->
    <div id="error-message" style="display: none; color: red; margin-top: 10px;"></div>

    <!-- Display User ID and Wallet Address -->
    <div class="user-id-container">
        <p><strong>User ID:</strong> <span id="user-id">Loading...</span></p>
        <p><strong>Wallet Address:</strong> <span id="wallet-address">Fetching wallet address...</span> <!-- New address display --></p>
    </div>

    <script src="script.js" defer></script>
    <script>
        let tg = window.Telegram.WebApp;
    
        // Get user details
        let username = tg.initDataUnsafe?.user?.first_name || "User";
        let userId = tg.initDataUnsafe?.user?.id || null;

        // Display username
        document.getElementById("username").innerText = username;

        // Display user ID
        document.getElementById("user-id").innerText = userId || "Not available";

        // Initialize Firebase and Firestore
        const firebaseConfig = {
            apiKey: "AIzaSyBi5bXxOygi0xsx22A6HCz2BW1e6vhFMgA",
            authDomain: "test-algo-public.firebaseapp.com",
            projectId: "test-algo-public",
            storageBucket: "test-algo-public.appspot.com",
            messagingSenderId: "510975939116",
            appId: "1:510975939116:web:4d51fd30f0d0da025df789"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Fetch wallet address based on user ID directly from the user-id displayed on the page
        const userIdFromPage = document.getElementById("user-id").innerText;
        console.log("User ID from Page:", userIdFromPage);  // Log user ID for debugging

        // Query the database using userId from page (ensure it's a valid number)
        if (userIdFromPage && !isNaN(userIdFromPage)) {
            db.collection("user_addresses").where("user_id", "==", Number(userIdFromPage))  // Ensure it's the right type
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        document.getElementById("wallet-address").innerText = "No address found.";
                    } else {
                        querySnapshot.forEach(doc => {
                            const userAddress = doc.data().address;
                            console.log("User Address from Firestore:", userAddress);  // Log the address fetched from Firestore
                            document.getElementById("wallet-address").innerText = userAddress || "No address found.";

                            // Now, call the function to refresh balance after wallet address is set
                            refreshBalance(userAddress);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error fetching wallet address:", error);
                    document.getElementById("wallet-address").innerText = "Error fetching address.";
                });
        } else {
            document.getElementById("wallet-address").innerText = "Invalid User ID.";
        }

        // Load Coin Flip Animation
        var animation = lottie.loadAnimation({
            container: document.getElementById("coin-animation"),
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "animation.json"
        });
    
        // Handle Heads & Tails Button Selection with Haptic Feedback
        document.querySelectorAll(".coin-button").forEach(button => {
            button.addEventListener("click", function() {
                // Remove active state from all buttons
                document.querySelectorAll(".coin-button").forEach(btn => {
                    btn.classList.remove("active");
                });
    
                // Add active state to clicked button
                this.classList.add("active");
    
                // Apply LIGHT haptic feedback for heads/tails
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            });
        });
    
        // Handle Withdraw Button with SOFT Haptic Feedback
        document.querySelector(".withdraw-button").addEventListener("click", function() {
            Telegram.WebApp.HapticFeedback.impactOccurred('soft');
        });
    
        // Handle Spin Button with HEAVY Haptic Feedback
        document.querySelector(".spin-button").addEventListener("click", function() {
            Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
        });
    </script>

<script>

    // Handle the Spin Button with Background Blur, Haptic Feedback, and Hiding UI elements
    document.querySelector(".spin-button").addEventListener("click", function() {
        // Apply background blur
        document.body.style.filter = 'blur(5px)';
        
        // Hide UI elements (example: buttons and balance section)
        document.querySelector(".coin-button").style.display = 'none'; 
        document.querySelector(".withdraw-button").style.display = 'none';
        document.querySelector(".balance-container").style.display = 'none';

        // Start the spin animation (if applicable)
        var animation = lottie.loadAnimation({
            container: document.getElementById("coin-animation"),
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "animation.json"
        });

        // Fast, continuous haptic feedback during the spin
        let hapticInterval = setInterval(function() {
            Telegram.WebApp.HapticFeedback.impactOccurred('light'); // Trigger light haptic feedback
        }, 100); // Trigger haptic feedback every 100 milliseconds

        // Simulate awaiting result (use setTimeout for demonstration; replace with your actual result fetching logic)
        setTimeout(function() {
            // Stop the haptic feedback loop
            clearInterval(hapticInterval);

            // Revert background blur
            document.body.style.filter = 'none';

            // Show UI elements again (e.g., buttons, balance section)
            document.querySelector(".coin-button").style.display = 'block';
            document.querySelector(".withdraw-button").style.display = 'block';
            document.querySelector(".balance-container").style.display = 'block';

            // Stop the spin animation
            animation.stop();

            // Display result popup (replace this with your actual result logic)
            alert("Spin result: Heads!"); // Example of showing result
        }, 5000); // Wait for 5 seconds before showing result (replace with actual result delay)
    });
</script>

</body>
</html>
