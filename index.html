<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Coin Flip App</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
   <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- HEADER -->
    <header class="header">
       <div class="user-info">
          <p class="welcome-text">Welcome Back 
             <img 
                src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/main/Travel%20and%20Places/Rocket.webp" 
                alt="Rocket Emoji" 
                width="30"  <!-- Increased size -->
          </p>
       </div>
       <img src="profile.png" alt="Profile Picture" id="profile-pic" class="profile-pic">
    </header>

<!-- Balance & Withdraw Container -->
<div class="balance-container">
   <div class="balance-wrapper">
       <img src="algo-icon.png" alt="Algo Icon" class="algo-icon">
       <div class="balance-text">
          <p class="balance-label">Balance</p>
          <p class="user-balance" id="user-balance">Loading...</p>
       </div>
   </div>

   <button class="withdraw-button" onclick="refreshBalance()">Refresh</button>
</div>

<!-- Coin Flip Animation -->
<div id="coin-flip-container">
   <div id="coin-animation"></div>
</div>

<!-- Heads & Tails Selection -->
<div class="button-container">
   <button class="coin-button" id="heads">
      <div class="top">HEADS</div>
      <div class="bottom"></div>
   </button>
   <button class="coin-button" id="tails">
      <div class="top">TAILS</div>
      <div class="bottom"></div>
   </button>
</div>

<!-- Spin Button -->
<div class="spin-container">
   <button class="spin-button">
      <div class="top">
         SPIN 
         <img 
            src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/main/Objects/Money%20Bag.webp"  
            alt="Money Bag Emoji" 
            width="30"  <!-- Increased size -->
      </div>
      <div class="bottom"></div>
   </button>
</div>

<!-- Display User ID and Wallet Address -->
<div class="user-id-container">
    <p><strong>Wallet Address:</strong> <span id="wallet-address">Fetching wallet address...</span></p>
</div>

<script src="script.js" defer></script>
<script>
    let tg = window.Telegram.WebApp;
    
    // Get user details (username and userId)
    let username = tg.initDataUnsafe?.user?.first_name || "User";
    let userId = tg.initDataUnsafe?.user?.id || null;

    // Use these variables internally (you can use them for processing, API calls, etc.)
    console.log("Username:", username);
    console.log("User ID:", userId);

    // You don't need to display them anymore, but you can still use them internally as needed.

    // Initialize Firebase and Firestore
    const firebaseConfig = {
        apiKey: "AIzaSyBi5bXxOygi0xsx22A6HCz2BW1e6vhFMgA",
        authDomain: "test-algo-public.firebaseapp.com",
        projectId: "test-algo-public",
        storageBucket: "test-algo-public.appspot.com",
        messagingSenderId: "510975939116",
        appId: "1:510975939116:web:4d51fd30f0d0da025df789"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Fetch wallet address based on user ID
    const userIdFromPage = userId; // Using the userId from the above assignment
    console.log("User ID from Page:", userIdFromPage);  

    // Query the database using userId (ensure it's a valid number)
    if (userIdFromPage && !isNaN(userIdFromPage)) {
        db.collection("user_addresses").where("user_id", "==", Number(userIdFromPage))
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    document.getElementById("wallet-address").innerText = "No address found.";
                } else {
                    querySnapshot.forEach(doc => {
                        const userAddress = doc.data().address;
                        console.log("User Address from Firestore:", userAddress);
                        document.getElementById("wallet-address").innerText = userAddress || "No address found.";
                        refreshBalance(userAddress);
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching wallet address:", error);
                document.getElementById("wallet-address").innerText = "Error fetching address.";
            });
    } else {
        document.getElementById("wallet-address").innerText = "Invalid User ID.";
    }

    // Load Coin Flip Animation
    var animation = lottie.loadAnimation({
        container: document.getElementById("coin-animation"),
        renderer: "svg",
        loop: true,
        autoplay: true,
        path: "animation.json"
    });

    // Handle Heads & Tails Button Selection with Haptic Feedback
    document.querySelectorAll(".coin-button").forEach(button => {
        button.addEventListener("click", function() {
            document.querySelectorAll(".coin-button").forEach(btn => {
                btn.classList.remove("active");
            });

            this.classList.add("active");
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
        });
    });

    // Handle Withdraw Button with SOFT Haptic Feedback
    document.querySelector(".withdraw-button").addEventListener("click", function() {
        Telegram.WebApp.HapticFeedback.impactOccurred('soft');
    });

    // Handle Spin Button with HEAVY Haptic Feedback
    document.querySelector(".spin-button").addEventListener("click", function() {
        Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
    });
</script>

<script type="module" src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    
</body>
</html>
